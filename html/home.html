<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="msapplication-tap-highlight" content="no">
  <title>MusicViz Homepage</title>
  <link rel="stylesheet" href="../chui/chui-ios-3.5.2.css">
  <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
  <script src="../chui/chui-3.5.2.js"></script>
  <style>
    .button.action {
      min-width: 200px;
      max-width: 300px;
      margin: 20px auto;
      display: block;
    }
    #username_display {
      font-weight: bold;
    }
    #username_update_div {
      display: none;
    }
    .align-right {
      display: inline;
      float: left;
    }
    li {
      overflow: auto;
    }
    a {
      text-decoration: none;
    }
  </style>
  <script type="text/javascript">
    var cur_user = "Anonymous";
    var cur_userID;
    $(function() {
      cur_userID = getQueryVariable('user');
      if (cur_userID == null) cur_userID = 0;
      $("#username_display").html(cur_user);
      $('input[name="username_join"]').val(cur_user);
      $.UISlideout();
      $.UISlideout.populate([{main:'Home'},{header:'Actions'},{join_room:'Join Room'}]);
      getMyRooms();
      getNearbyRooms();
      $("#username_update_form").submit(function() {
        $("#username_display").html($("#username_input").val());
        $('input[name="username_join"]').val($("#username_input").val());
        cur_user = $("#username_input").val();
        cur_userID = 0;
        $("#username_input").val('');
        $("#username_update_div").css("display", "none");
      });
    });
    function showUsernameUpdateDiv() {
      $("#username_update_div").css("display", "block");
    };
    function submitJoinRoom() {
      var form_username = $('input[name="username_join"]').val();
      if (form_username != cur_user) {
        cur_user = form_username;
        cur_userID = 0;
        $("#username_display").html(cur_user);
      }
      var roomID = $("#id_join").val();
      var joinPassword = $("#password_join").val();
      joinRoom(roomID, joinPassword);
    };
    function getMyRooms() {
      //alert("my user id: " + cur_userID);
      $.ajax({
        type: "POST",
        url: "/search_room",
        data: {user_id: cur_userID},
        success: function(data) {
          //alert(data);
          $.each(data, function(index, itemData) {
            var password = itemData["password"];
            if (password == "") password = "null"
            $("#nearby_rooms").append(
              "<li>"
              + "Room Name: " + itemData["name"] + "<br>"
              + "Creator: " + itemData["creator_name"] + "<br>"
              + '<a href="javascript:joinRoom(' + itemData["id"] + ',' + password + ');" class="button action align-right" id="join_room_button">Join Room</a>'
              + '<a href="queue.html?user=' + cur_userID + '&id=' + itemData["id"] + '" class="button action align-right" id="view_queue_button">View Queue</a>'
              + "</li>"
            );
          });
        }
      });
    };
    function getNearbyRooms() {
      //alert("refreshing your rooms");
      $.ajax({
        type: "POST",
        url: "/search_room",
        data: {},
        success: function(data) {
          $.each(data, function(index, itemData) {
            var password = itemData["password"];
            if (password == "") password = "null"
            $("#nearby_rooms").empty();
            $("#nearby_rooms").append(
              "<li>"
              + "Room Name: " + itemData["name"] + "<br>"
              + "Creator: " + itemData["creator_name"] + "<br>"
              + '<a href="javascript:joinRoom(' + itemData["id"] + ',' + password + ');" class="button action align-right" id="join_room_button">Join Room</a>'
              + '<a href="queue.html?user=' + cur_userID + '&id=' + itemData["id"] + '" class="button action align-right" id="view_queue_button">View Queue</a>'
              + "</li>"
            );
          });
        }
      });
    };
    function joinRoom(roomID, password) {
      if (cur_userID == 0) {
        $.ajax({
          type: "POST",
          url: "/register_user",
          data: {username: cur_user},
          success: function(data) {
            alert("Registered user: " + data);
            cur_userID = data;
            ajaxJoin(roomID, password);
          }
        });
      } else {
        ajaxJoin(roomID, password);
      }
    };
    function ajaxJoin(roomID, password) {
      if (password == "null") password = "";
      $.ajax({
       type: "POST",
        url: "/join_room",
        data: {room_id: roomID, user_id: cur_userID, password: password},
        success: function(data) {
          alert("here is the daters: " + data);
          getMyRooms();
          getNearbyRooms();
        }
      }); 
    };
    function getQueryVariable(variable) {
      var query = window.location.search.substring(1);
      var vars = query.split("&");
      for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split("=");
        if (pair[0] == variable) { 
          return pair[1]; 
        }
      }
     return null;
    }
  </script>
</head>
<body>

    <nav>
      <h1>WELCOME TO MUSIC VIZ</h1>
      <a class='button' id='editButton'>Settings</a> 
    </nav>
    <article id="main">
      <section>
        <p style="text-align: center;">
            Your username is <span id="username_display"></span>
            <a href="javascript:showUsernameUpdateDiv();" id="open_user_popup">
              <label>(edit)</label>
            </a>
        </p>
        <div style="text-align: center;" id="username_update_div">
            <form id="username_update_form">
              New Username: <input type="text" id="username_input">
              <input type="submit" value="Update">
            </form>
        </div>
        <h2>My Rooms</h2>
        <ul class='list' id="my_rooms">
        </ul>
        <h2>Nearby Rooms</h2>
        <ul class='list' id="nearby_rooms">
        </ul>
      </section>
    </article>

    <nav>
      <h1>JOIN A ROOM</h1>
    </nav>
    <article id="join_room">
      <section>
        <h2>JOIN A ROOM</h2>
        <ul class='list' ui-implements='form'>
          <li>
            <input autocorrect="off" autocapitalize="words" type="text" id="id_join" placeholder="Room ID" required>
          </li>
          <li>
            <input autocorrect="off" autocapitalize="words" type="text" name="username_join" placeholder="Your Username" required>
          </li>
          <li>
           <input type="password" id="password_join" placeholder="Password" required>
          </li>
        </ul>
        <a href="javascript:submitJoinRoom();" class='button action' id="join_room_button">Join Room</a>
      </section>
    </article>

  </body>
</html>