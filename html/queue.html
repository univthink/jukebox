<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="msapplication-tap-highlight" content="no">
  <title>MusicViz Homepage</title>
  <link rel="stylesheet" href="../chui/chui-ios-3.5.2.css">
  <link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
  <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
  <script src="../chui/chui-3.5.2.js"></script>
  <script src="http://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
  <style>
    .square {
      width: 50px;
      height: 50px;   
      background: red;
      border-radius: 10px;
    }
    .fitParent {
      display: block;
      width:100%;
      height:100%;
    }
  </style>
  <script type="text/javascript">
    var userID;
    var roomID;
    var colors = ['red', 'blue', 'green', 'pink'];
    function getQueryVariable(variable) {
      var query = window.location.search.substring(1);
      var vars = query.split("&");
      for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split("=");
        if (pair[0] == variable) { 
          return pair[1]; 
        }
      }
      return null;
    }
    function submitSong (roomID, autocompleteData) {
      $.ajax({
        type: "POST",
        url: "/submit_song",
        data: {room_id: roomID, user_id: userID, url:autocompleteData.url, track:autocompleteData.name, artist:autocompleteData.artist, album:autocompleteData.album},
        success: function(data) {
          console.log(data);
          displayQueue(roomID)
          $("#spotify_song_search").val('')
        }
      });
    }
    function displayQueue(roomID) {
      $.ajax({
        type: "GET",
        url: "/get_song_queue",
        data: {room_id: roomID},
        success: function(data) {
          if (data != 0) {
            $.each(data, function(index, song) {
              var sColor = colors[Math.floor((Math.random()*colors.length))];
              $("#queue_list").append(
                '<li class="comp">'
                + '<aside>'
                + '<div class="square" style="background:' + sColor + ';"'
                + '><img /></div>'
                + '</aside>'
                + '<div>'
                + '<h3>' + song["artist"] + '</h3>'
                + '<h4>' + song["track"] + '</h4>'
                + '<p>' + song["album"] + '</p>'
                + '</div>'
                + '</li>'
              );
            });
          } else {
            $("#queue_list").append('<li class="comp">Room ID does not exist.</li>');
          }
        }
      });
    }
    $(function() {
      userID = getQueryVariable("user");
      if (userID == null) userID = 0;
      roomID = getQueryVariable("id");
      if (roomID) displayQueue(roomID);
      else {
        $("#queue_list").append('<li class="comp">No room ID provided.</li>');
      }
      $("#homeButton").attr("href", "home.html?user=" + userID);
      $("#spotify_song_search").autocomplete({
        source: function(request, response) {
            $.get("http://ws.spotify.com/search/1/track.json", {
              //currently selected in input
                q: request.term
            }, function(data) {
                console.log(data)
                response($.map(data.tracks, function(item) {
                    return {label: item.name +" by " + item.artists[0].name, data: {artist: item.artists[0].name, album: item.album.name, url: item.href, name: item.name}};
                }));
            });
        },
        select: function(event, ui) {
          console.log(ui)
          submitSong(roomID, ui.item.data)
        },
        messages: {
            noResults: '',
            results: function() {}
        }
      });
    });
  </script>
</head>
<body>
  <nav>
    <a href="home.html" class='button' id='homeButton'>Home</a> 
    <h1>QUEUE</h1>
    <a class='button' id='editButton'>Edit</a> 
  </nav>
  <article id="main" class="current">
    <section>
        <h2>Search Songs</h2>
        <ul class='list' ui-implements='form'>
          <li>
            <input class="fitParent" id="spotify_song_search" placeholder="Search Song Name">
          </li>
        </ul>
        <h2>Music Playlist</h2>
      <ul class='list' id="queue_list">
      </ul>  
    </section>
  </article>
</body>
</html>