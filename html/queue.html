r<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="msapplication-tap-highlight" content="no">
  <title>MusicViz Homepage</title>
  <link rel="stylesheet" href="../chui/chui-ios-3.5.2.css">
  <link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
  <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
  <script src="../chui/chui-3.5.2.js"></script>
  <script src="../js/jquery.sortable.js"></script>
  <script src="http://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
  <style>
    .square {
      width: 60px;
      height: 60px;   
      background: red;
      border-radius: 10px;
      margin-left: 8px;
      margin-right: 8px;
    }
    .fitParent {
      display: block;
      width:100%;
      height:100%;
    }
    .ui-autocomplete {
      background: #4a4a4a;
      border-radius: 0px;
    }
    .ui-autocomplete.source:hover {
      background: #454545;
    }
    .ui-menu .ui-menu-item a {
      background:red;
      height:10px;
      font-size:8px;
    }
  </style>
  <script type="text/javascript">
    // global vars
    var cur_user;
    var cur_userID;
    var roomID;
    var qr = 0;
    var sortable = false;
    var colors = ['red', 'blue', 'green', 'pink'];
    var usernames = ['Oak', 'Misty', 'Ash', 'Brock', 'Mai']
    function getQueryVariable(variable) {
      var query = window.location.search.substring(1);
      var vars = query.split("&");
      for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split("=");
        if (pair[0] == variable) { 
          return pair[1]; 
        }
      }
      return null;
    }
    function submitSong (roomID, autocompleteData) {
      $.ajax({
        type: "POST",
        url: "/submit_song",
        data: {room_id: roomID, user_id: cur_userID, url:autocompleteData.url, track:autocompleteData.name, artist:autocompleteData.artist, album:autocompleteData.album},
        success: function(data) {
          if (data) alert("Song added successfully!");
          displayQueue(roomID)
          $("#spotify_song_search").val('')
        }
      });
    }
    function displayQueue(roomID) {
      $.ajax({
        type: "GET",
        url: "/get_song_queue",
        data: {room_id: roomID},
        success: function(data) {
          if (data != 0) {
            $("#queue_list").empty();
            $.each(data, function(index, song) {
              var sColor = colors[Math.floor((Math.random()*colors.length))];
              $("#queue_list").append(
                '<li class="comp">'
                + '<aside>'
                + '<div class="square" style="background:' + sColor + ';"'
                + '><img /></div>'
                + '</aside>'
                + '<div>'
                + '<h3>' + song["track"] + '</h3>'
                + '<h4>' + song["artist"] + '</h4>'
                + '<p>' + song["album"] + '</p>'
                + '<span style="display:none;">' + song["url"] + '</span>'
                + '</div>'
                + '</li>'
              );
            });
            $.UIDeletable({
              list: '#queue_list', 
              callback: function(item) {
                var url = $(item).siblings('div').find('span').text(); //url is not unique (think: duplicates)
                alert("You deleted " + url);
              }
            });
          } else {
            $("#queue_list").append('<li class="comp">Room ID does not exist.</li>');
          }
        }
      });
    }
    function registerUser(username, callback) {
      $.ajax({
        type: "POST",
        url: "/register_user",
        data: {username: username},
        success: function(userID) {
          cur_userID = userID;
          callback();
        }
      });
    };
    function ajaxJoin(roomID, userID, password, callback) {
      if (password == "null") password = "";
      $.ajax({
       type: "POST",
        url: "/join_room",
        data: {room_id: roomID, user_id: userID, password: password},
        success: function(data) {
          callback();
        }
      }); 
    };
    function callbackOnRegister() {
      ajaxJoin(roomID, cur_userID, "", function() {
        $("#homeButton").attr("href", "home.html?user=" + cur_userID);
        $("#spotify_song_search").autocomplete({
          source: function(request, response) {
              $.get("http://ws.spotify.com/search/1/track.json", {
                //currently selected in input
                  q: request.term
              }, function(data) {
                  //console.log(data)
                  response($.map(data.tracks, function(item) {
                      return {label: item.artists[0].name + " - " + item.name, data: {artist: item.artists[0].name, album: item.album.name, url: item.href, name: item.name}};
                  }));
              });
          },
          select: function(event, ui) {
            //console.log(ui);
            if (cur_userID == 0) {
              alert("You are not a registered user. You may not add a song to this queue.")
            } else {
              submitSong(roomID, ui.item.data);
            }
          },
          messages: {
              noResults: '',
              results: function() {}
          }
        });
      });
    }
    function toggleSortDelete() {
      sortable = !sortable;
      if (sortable) {
        $('.sortable').sortable('enable');
      } else {
        $('.sortable').sortable('disable');
      }
    }
    $(function() {
      cur_userID = getQueryVariable("user");
      if (cur_userID == null) cur_userID = 0;

      roomID = getQueryVariable("id");
      if (roomID) {
        displayQueue(roomID);
      } else {
        $("#queue_list").append('<li class="comp">No room ID provided.</li>');
      }

      if (getQueryVariable("qr")) qr = 1;
      if (qr) {
        registerUser("Anonymous", callbackOnRegister);
      } else {
        callbackOnRegister();
      }

      $('.sortable').sortable();
      $('.sortable').sortable('disable');


    });
  </script>
</head>
<body>
  <nav>
    <a href="home.html" class='button' id='homeButton'>Home</a> 
    <h1>QUEUE</h1>
    <!--<a href="javascript:toggleSortDelete();" class='button' id='editButton'>Edit</a> -->
  </nav>
  <article id="main" class="current">
    <section>
        <h2>Add A Song</h2>
        <ul class='list' ui-implements='form'>
          <li>
            <input class="fitParent" id="spotify_song_search" placeholder="Search Song Name">
          </li>
        </ul>
        <h2>Music Playlist</h2>
          <ul class='list sortable' id="queue_list">
          </ul>  
    </section>
  </article>
</body>
</html>